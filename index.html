

}
return applied;
}


function urgencyStyle(u){ if(u==='Alta') return {text:u, bg:'var(--danger)', color:'#fff'}; if(u==='Média') return {text:u, bg:'#f59e0b', color:'#000'}; return {text:u, bg:'#16a34a', color:'#fff'}; }


document.getElementById('symptomForm').addEventListener('submit', (e)=>{
e.preventDefault();
const symptoms = getSelectedSymptoms();
const duration = Number(document.getElementById('duration').value || 0);
const intensity = Number(document.getElementById('intensity').value || 1);
const extra = document.getElementById('extra').value.trim();


// aplicar regras
const matches = applyRules(symptoms, cfg.rules);
let final = null; let appliedRulesText='';
if(matches.length>0){ matches.sort((a,b)=>b.score-a.score); final = matches[0]; appliedRulesText = matches.map(m=>`Regra: ${m.label} (id:${m.id})\nSintomas exigidos: ${m.must.join(', ')}\n`).join('\n'); }
else{
// heurística parcial
const candidates = cfg.rules.map(r=>({...r, common: r.must.filter(x=>symptoms.includes(x)).length})).filter(r=>r.common>0);
if(candidates.length>0){ candidates.sort((a,b)=>b.common-a.common); final={...candidates[0], label:candidates[0].label + ' (possível, por semelhança)'}; appliedRulesText = candidates.map(c=>`Regra (parcial): ${c.label} (comuns:${c.common})\nSintomas exigidos: ${c.must.join(', ')}\n`).join('\n'); }
}


const resultCard = document.getElementById('result'); const matchSummary = document.getElementById('matchSummary'); const urgencyBadge = document.getElementById('urgencyBadge'); const recsEl = document.getElementById('recommendations'); const rulesApplied = document.getElementById('rulesApplied');


if(!final){ matchSummary.textContent = 'Nenhuma combinação padrão encontrada. Observe e procure ajuda se houver piora.'; urgencyBadge.textContent='Observação'; urgencyBadge.style.background='#94a3b8'; urgencyBadge.style.color='#04203a'; recsEl.innerHTML = '<ul><li>Monitorar sintomas</li><li>Manter hidratação</li><li>Procurar atendimento se houver agravamento</li></ul>'; rulesApplied.textContent = appliedRulesText || 'Nenhuma regra aplicada.'; }
else{
matchSummary.textContent = `Possível indicação: ${final.label}. (Baseado nas regras do sistema)`;
const s = urgencyStyle(final.urgency);
urgencyBadge.textContent = final.urgency; urgencyBadge.style.background = s.bg; urgencyBadge.style.color = s.color;
recsEl.innerHTML = '<ul>' + final.recs.map(r=>`<li>${r}</li>`).join('') + '</ul>';
rulesApplied.textContent = appliedRulesText;
}


rulesApplied.textContent += `\nContexto:\nDuração (dias): ${duration}\nIntensidade: ${intensity}\nInfo adicional: ${extra || 'nenhuma'}`;
resultCard.classList.remove('hidden');
});


// limpar
document.getElementById('clearBtn').addEventListener('click', ()=>{ document.querySelectorAll('input[name="symptom"]').forEach(i=>i.checked=false); document.getElementById('duration').value=1; document.getElementById('intensity').value=2; document.getElementById('extra').value=''; document.getElementById('result').classList.add('hidden'); });


// preencher campos iniciais do modal e UI
applyAccent(cfg.accent);
cfgTitle.value = cfg.title; cfgDesc.value = cfg.desc; cfgAccent.value = cfg.accent; cfgFormUrl.value = cfg.formUrl; cfgSymptoms.value = cfg.symptoms.join('\n'); cfgRules.value = JSON.stringify(cfg.rules, null, 2);
renderSymptoms(cfg.symptoms); renderRulesTable(cfg.rules); setFormLink(cfg.formUrl);


// última data salva
if(getLastSaved()){ lastSaved.textContent = (new Date(getLastSaved())).toLocaleString(); }


// setar evento para fechar modal ao clicar fora
settingsModal.addEventListener('click', (e)=>{ if(e.target===settingsModal){ settingsModal.classList.add('hidden'); settingsModal.classList.remove('flex'); } });


// prevenir propagation
document.querySelectorAll('label > input').forEach(i=>i.addEventListener('click', e=>e.stopPropagation()));


// inicial: salvar default se nada salvo
if(!loadFromStorage()){ saveToStorage(DEFAULT); }
</script>
</body>
</html>
